# 局域网访问快速修复指南

## 问题：其他设备访问显示 "Load failed"

### ✅ 已完成的修复

1. **移除了硬编码的 API 地址**
   - 修改了 `frontend/.env.local`，移除了 `VITE_API_URL=http://localhost:8000`
   - 重新构建了前端，现在会自动检测 API 地址

2. **前端已重新构建**
   - 运行了 `npm run build`
   - 新的构建文件已生成在 `frontend/dist/`

3. **创建了诊断工具**
   - 访问 `http://172.18.16.245:8000/test-connection.html` 可以测试连接

## 🚀 立即测试

### 步骤 1：启动后端服务

在主机上运行：
```bash
python scripts/start_local.py
```

确认看到：
```
============================================================
🌟 治愈系记录助手 - SoulMate AI Companion
============================================================
📍 本地访问: http://localhost:8000/
📍 局域网访问: http://172.18.16.245:8000/
============================================================
```

### 步骤 2：在其他设备上测试

#### 测试 1：访问诊断页面
在其他设备的浏览器中打开：
```
http://172.18.16.245:8000/test-connection.html
```

点击 "🚀 开始测试" 按钮，查看所有 API 是否可以访问。

#### 测试 2：访问主应用
在其他设备的浏览器中打开：
```
http://172.18.16.245:8000/
```

应该可以正常加载并显示数据。

## 🔧 如果仍然失败

### 方案 1：检查防火墙（最常见原因）

#### Windows 防火墙快速测试
1. 临时关闭防火墙测试（以管理员身份运行 PowerShell）：
```powershell
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
```

2. 在其他设备上重新访问 `http://172.18.16.245:8000/`

3. 如果可以访问了，说明是防火墙问题，需要添加规则：
```powershell
# 允许 Python 通过防火墙
New-NetFirewallRule -DisplayName "Python FastAPI 8000" -Direction Inbound -LocalPort 8000 -Protocol TCP -Action Allow
```

4. 重新启用防火墙：
```powershell
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True
```

### 方案 2：检查网络连接

在其他设备上测试能否 ping 通主机：
```bash
ping 172.18.16.245
```

如果 ping 不通：
- 确认两台设备在同一 WiFi 网络
- 检查路由器是否启用了 AP 隔离（需要在路由器设置中关闭）
- 确认主机 IP 地址是否正确（可能已变化）

### 方案 3：检查 IP 地址

主机 IP 可能已经变化，重新获取：
```bash
# Windows
ipconfig

# 查找 "IPv4 地址"，例如：192.168.1.100
```

使用新的 IP 地址访问。

### 方案 4：使用浏览器开发者工具

在其他设备的浏览器中：
1. 按 F12 打开开发者工具
2. 切换到 "Console" 标签
3. 刷新页面
4. 查看具体的错误信息

**常见错误及解决方案**：

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `Failed to fetch` | 网络连接失败 | 检查防火墙和网络连接 |
| `net::ERR_CONNECTION_REFUSED` | 端口未开放 | 检查后端是否运行，防火墙是否允许 |
| `net::ERR_CONNECTION_TIMED_OUT` | 连接超时 | 检查网络连接，可能是路由器 AP 隔离 |
| `CORS error` | CORS 配置问题 | 已配置，不应该出现此错误 |

## 📱 移动设备特别说明

如果从手机访问：
1. 确保手机连接的是同一个 WiFi 网络（不是移动数据）
2. 某些公共 WiFi 可能禁止设备间通信
3. 可以尝试使用手机的浏览器访问诊断页面

## ✅ 成功标志

当以下测试都通过时，说明配置正确：

1. ✅ 诊断页面所有测试都显示绿色 ✅
2. ✅ 主应用可以正常加载
3. ✅ 可以看到 AI 角色形象
4. ✅ 可以进行语音输入和文本输入
5. ✅ 可以查看心情、灵感、待办数据

## 🆘 仍然无法解决？

请提供以下信息：

1. **诊断页面的测试结果**（截图）
2. **浏览器控制台的错误信息**（截图或文字）
3. **主机上运行的结果**：
   ```bash
   curl http://localhost:8000/health
   ```
4. **其他设备上的测试结果**：
   - 能否 ping 通主机
   - 访问 `http://172.18.16.245:8000/health` 的结果
5. **防火墙状态**：
   ```powershell
   netsh advfirewall show allprofiles state
   ```

## 📚 相关文档

- [局域网访问问题排查](./局域网访问问题排查.md) - 详细的排查步骤
- [局域网访问指南](./局域网访问指南.md) - 完整的配置指南
