# 局域网访问问题排查指南

## 问题描述
从其他设备访问 `http://172.18.16.245:8000/` 时显示 "Load failed"

## 排查步骤

### 1. 确认后端服务正在运行
在主机上运行：
```bash
python scripts/start_local.py
```

确认看到以下输出：
```
============================================================
🌟 治愈系记录助手 - SoulMate AI Companion
============================================================
📍 本地访问: http://localhost:8000/
📍 局域网访问: http://172.18.16.245:8000/
📚 API 文档: http://localhost:8000/docs
🔍 健康检查: http://localhost:8000/health
============================================================
```

### 2. 测试后端 API 是否可访问

#### 在主机上测试（应该成功）：
```bash
curl http://localhost:8000/health
```

#### 在其他设备上测试（关键）：
打开浏览器访问：
```
http://172.18.16.245:8000/health
```

**预期结果**：应该看到 JSON 响应
```json
{
  "status": "healthy",
  "data_dir": "data",
  "max_audio_size": 10485760
}
```

**如果失败**：说明网络连接有问题，继续下一步

### 3. 检查防火墙设置

#### Windows 防火墙
1. 打开 "Windows Defender 防火墙"
2. 点击 "允许应用通过防火墙"
3. 确保 Python 已被允许（专用网络和公用网络都勾选）

#### 或者临时关闭防火墙测试：
```powershell
# 以管理员身份运行 PowerShell
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
```

测试完成后记得重新开启：
```powershell
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True
```

### 4. 检查网络连接

#### 在其他设备上 ping 主机：
```bash
ping 172.18.16.245
```

**预期结果**：应该能 ping 通

**如果失败**：
- 确认两台设备在同一局域网
- 检查主机的 IP 地址是否正确（可能已变化）

#### 获取当前 IP 地址：
```bash
# Windows
ipconfig

# 查找 "IPv4 地址" 或 "IPv4 Address"
```

### 5. 检查端口是否被占用

```bash
# Windows
netstat -ano | findstr :8000
```

如果端口被占用，更换端口或关闭占用端口的程序

### 6. 浏览器控制台检查

在其他设备的浏览器中：
1. 按 F12 打开开发者工具
2. 切换到 "Console" 标签
3. 刷新页面
4. 查看错误信息

**常见错误**：
- `Failed to fetch`: 网络连接问题
- `CORS error`: CORS 配置问题（但我们已经配置了）
- `404 Not Found`: API 路径错误
- `Timeout`: 请求超时

### 7. 测试 API 端点

在其他设备的浏览器中依次访问：

1. **健康检查**：`http://172.18.16.245:8000/health`
2. **API 状态**：`http://172.18.16.245:8000/api/status`
3. **前端页面**：`http://172.18.16.245:8000/`

记录每个请求的结果

### 8. 检查 CORS 配置

后端已配置允许所有来源：
```python
allow_origins=["*"]
```

但如果仍有问题，可以尝试更明确的配置：
```python
allow_origins=[
    "http://localhost:5173",
    "http://localhost:3000",
    "http://172.18.16.245:5173",
    "http://172.18.16.245:8000",
    "*"
]
```

## 快速诊断命令

在主机上运行以下命令，将结果发给我：

```bash
# 1. 检查服务是否运行
curl http://localhost:8000/health

# 2. 检查端口监听
netstat -ano | findstr :8000

# 3. 检查 IP 地址
ipconfig | findstr IPv4

# 4. 检查防火墙状态
netsh advfirewall show allprofiles state
```

## 解决方案

### 方案 1：临时关闭防火墙测试
如果关闭防火墙后可以访问，说明是防火墙问题，需要添加防火墙规则

### 方案 2：添加防火墙规则
```powershell
# 以管理员身份运行
New-NetFirewallRule -DisplayName "Python FastAPI" -Direction Inbound -Program "C:\Path\To\Python\python.exe" -Action Allow
```

### 方案 3：使用不同的端口
如果 8000 端口有问题，可以尝试其他端口（如 8080, 5000）

修改 `scripts/start_local.py` 中的端口号

### 方案 4：检查路由器设置
某些路由器可能阻止设备间通信（AP 隔离），需要在路由器设置中关闭

## 成功标志

当以下所有测试都通过时，说明配置正确：

1. ✅ 主机可以访问 `http://localhost:8000/health`
2. ✅ 其他设备可以 ping 通 `172.18.16.245`
3. ✅ 其他设备可以访问 `http://172.18.16.245:8000/health`
4. ✅ 其他设备可以访问 `http://172.18.16.245:8000/`
5. ✅ 前端可以正常加载并显示数据

## 需要提供的信息

如果问题仍未解决，请提供：

1. 浏览器控制台的完整错误信息（截图或文字）
2. 主机上运行 `curl http://localhost:8000/health` 的结果
3. 其他设备上访问 `http://172.18.16.245:8000/health` 的结果
4. 防火墙状态
5. 两台设备是否在同一局域网
