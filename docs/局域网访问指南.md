# 局域网访问指南

## 🌐 让其他设备访问你的应用

### 快速开始

#### 1. 启动本地服务器

**Windows:**
```bash
start_local.bat
```

**Linux/Mac:**
```bash
python start_local.py
```

服务器会显示：
```
============================================================
🌟 治愈系记录助手 - SoulMate AI Companion
============================================================
📍 本地访问: http://localhost:8000/
📍 局域网访问: http://172.18.16.245:8000/
📚 API 文档: http://localhost:8000/docs
🔍 健康检查: http://localhost:8000/health
============================================================
💡 提示: 其他设备可以通过 http://172.18.16.245:8000/ 访问
============================================================
```

#### 2. 其他设备访问

在同一局域网内的其他设备（手机、平板、其他电脑）上：

1. 打开浏览器
2. 访问：`http://172.18.16.245:8000/`（使用你的实际 IP 地址）
3. 开始使用！

### 前置要求

#### 1. 构建前端

首次使用前，需要构建前端：

```bash
cd frontend
npm install
npm run build
cd ..
```

#### 2. 配置防火墙

**Windows 防火墙：**

1. 打开 Windows Defender 防火墙
2. 点击"高级设置"
3. 选择"入站规则" → "新建规则"
4. 选择"端口" → 下一步
5. 选择"TCP"，特定本地端口：`8000`
6. 允许连接
7. 应用到所有配置文件
8. 命名规则：`SoulMate AI - Port 8000`

**或使用命令行（管理员权限）：**
```powershell
netsh advfirewall firewall add rule name="SoulMate AI - Port 8000" dir=in action=allow protocol=TCP localport=8000
```

**Linux (ufw):**
```bash
sudo ufw allow 8000/tcp
```

**Mac:**
系统偏好设置 → 安全性与隐私 → 防火墙 → 防火墙选项 → 添加应用

#### 3. 确保在同一网络

- 所有设备连接到同一个 WiFi 或局域网
- 检查路由器是否启用了 AP 隔离（如果启用需要关闭）

### 故障排查

#### 问题 1: 其他设备无法访问

**检查清单：**

1. ✅ 服务器是否正在运行？
   ```bash
   # 应该看到服务器日志
   INFO:     Uvicorn running on http://0.0.0.0:8000
   ```

2. ✅ 防火墙是否允许端口 8000？
   ```bash
   # Windows: 测试端口
   Test-NetConnection -ComputerName 172.18.16.245 -Port 8000
   ```

3. ✅ 设备是否在同一网络？
   ```bash
   # 从其他设备 ping 服务器
   ping 172.18.16.245
   ```

4. ✅ IP 地址是否正确？
   ```bash
   # Windows: 查看 IP
   ipconfig
   
   # Linux/Mac: 查看 IP
   ifconfig
   ```

#### 问题 2: API 调用失败

**检查浏览器控制台：**

1. 打开开发者工具（F12）
2. 查看 Console 标签
3. 应该看到：`🔗 API Base URL: http://172.18.16.245:8000`
4. 如果不正确，清除浏览器缓存并刷新

**测试 API 连接：**

访问：`http://172.18.16.245:8000/health`

应该返回：
```json
{
  "status": "healthy",
  "data_dir": "data",
  "max_audio_size": 10485760
}
```

#### 问题 3: 没有显示默认形象

**检查：**

1. ✅ 默认形象文件是否存在？
   ```bash
   # 应该存在这个文件
   generated_images/default_character.jpeg
   ```

2. ✅ 用户配置是否正确？
   ```bash
   # 查看配置文件
   cat data/user_config.json
   ```

3. ✅ 图片 URL 是否正确？
   - 访问：`http://172.18.16.245:8000/api/user/config`
   - 检查 `character.image_url` 字段

4. ✅ 图片是否可访问？
   - 访问：`http://172.18.16.245:8000/generated_images/default_character.jpeg`
   - 应该能看到图片

### 性能优化

#### 1. 使用有线连接

- 服务器电脑使用网线连接路由器
- 减少 WiFi 干扰和延迟

#### 2. 关闭不必要的应用

- 释放 CPU 和内存资源
- 提高响应速度

#### 3. 使用现代浏览器

- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

### 安全建议

⚠️ **注意：** 局域网访问仅适用于受信任的网络环境

1. **不要在公共 WiFi 上使用**
2. **定期更新 API 密钥**
3. **不要暴露到公网**
4. **使用强密码保护路由器**

### 高级配置

#### 自定义端口

编辑 `start_local.py`，修改端口号：

```python
uvicorn.run(
    app,
    host="0.0.0.0",
    port=8888,  # 改为你想要的端口
    log_level="info"
)
```

同时需要修改防火墙规则允许新端口。

#### 使用环境变量

创建 `.env.local` 文件：

```env
HOST=0.0.0.0
PORT=8000
```

### 常见使用场景

#### 场景 1: 手机访问电脑上的应用

1. 电脑运行 `start_local.bat`
2. 手机连接同一 WiFi
3. 手机浏览器访问 `http://172.18.16.245:8000/`
4. 可以语音输入、查看心情、与 AI 对话

#### 场景 2: 平板作为展示屏

1. 电脑运行服务器
2. 平板访问应用
3. 全屏显示心情气泡池
4. 作为情绪可视化展示

#### 场景 3: 多人协作

1. 一台电脑运行服务器
2. 团队成员通过局域网访问
3. 共享灵感和待办事项
4. 实时同步数据

### 技术细节

#### API 地址自动检测

前端会自动检测访问地址并配置 API：

```typescript
// 访问: http://172.18.16.245:5173/
// API:  http://172.18.16.245:8000/

// 访问: http://localhost:5173/
// API:  http://localhost:8000/
```

#### CORS 配置

后端已配置允许所有来源（开发环境）：

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

生产环境应该限制具体的域名。
